/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * Das2ServerDataSourceEditorPanel.java
 *
 * Created on Oct 16, 2009, 12:59:27 PM
 */

package org.das2.datasource;

import java.awt.Component;
import java.awt.Graphics;
import java.awt.Image;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.Reader;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultComboBoxModel;
import javax.swing.DefaultListCellRenderer;
import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.JTree;
import javax.swing.ListCellRenderer;
import javax.swing.SwingUtilities;
import javax.swing.text.DefaultEditorKit;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.TreeModel;
import javax.swing.tree.TreeNode;
import javax.swing.tree.TreePath;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import org.das2.DasException;
import org.das2.client.DasServer;
import org.das2.datum.Datum;
import org.das2.datum.DatumRange;
import org.das2.datum.DatumRangeUtil;
import org.das2.datum.TimeUtil;
import org.das2.system.RequestProcessor;
import org.das2.util.LoggerManager;
import org.das2.util.monitor.ProgressMonitor;
import org.virbo.datasource.AutoplotSettings;
import org.virbo.datasource.DataSetURI;
import org.virbo.datasource.DataSourceEditorPanel;
import org.virbo.datasource.TimeRangeTool;
import org.virbo.datasource.URISplit;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

/**
 *
 * @author jbf
 */
public class Das2ServerDataSourceEditorPanel extends javax.swing.JPanel implements DataSourceEditorPanel {

    private static final Logger logger= LoggerManager.getLogger("apdss.das2server");

    private static final String EXAMPLE_TIMERANGE_LABEL_DELIM = "|";

    //DANGER: NB gui code doesn't use this...
    private static final String EXAMPLE_TIME_RANGES = "<html><i>Example Time Ranges</i>";


    private final String DEFAULT_TIMERANGE="2001-01-01";

    /** Creates new form Das2ServerDataSourceEditorPanel */
    public Das2ServerDataSourceEditorPanel() {
        initComponents();
    }

    /**
     * list of servers we know about
     */
    List<String> d2ss;
	 
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        das2ServerComboBox = new javax.swing.JComboBox();
        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTree1 = new javax.swing.JTree();
        jLabel2 = new javax.swing.JLabel();
        timeRangeTextField = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jScrollPane2 = new javax.swing.JScrollPane();
        readerParamsTextArea = new javax.swing.JTextArea();
        jLabel5 = new javax.swing.JLabel();
        tcaTextField = new javax.swing.JTextField();
        jLabel6 = new javax.swing.JLabel();
        tcaItem = new javax.swing.JTextField();
        viewDsdfButton = new javax.swing.JButton();
        validRangeLabel = new javax.swing.JLabel();
        discoveryCb = new javax.swing.JCheckBox();
        examplesComboBox = new javax.swing.JComboBox();
        jLabel7 = new javax.swing.JLabel();
        descriptionLabel = new javax.swing.JLabel();
        timeRangeTool = new javax.swing.JButton();

        das2ServerComboBox.setEditable(true);
        das2ServerComboBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "http://www-pw.physics.uiowa.edu/das/das2Server", "http://cassini.physics.uiowa.edu/das/das2Server" }));
        das2ServerComboBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                das2ServerComboBoxActionPerformed(evt);
            }
        });

        jLabel1.setText("Das2 Server URL:");

        javax.swing.tree.DefaultMutableTreeNode treeNode1 = new javax.swing.tree.DefaultMutableTreeNode("Loading DataSets List...");
        jTree1.setModel(new javax.swing.tree.DefaultTreeModel(treeNode1));
        jTree1.addTreeSelectionListener(new javax.swing.event.TreeSelectionListener() {
            public void valueChanged(javax.swing.event.TreeSelectionEvent evt) {
                jTree1ValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(jTree1);

        jLabel2.setText("Data Set Id:");

        timeRangeTextField.setText(DEFAULT_TIMERANGE);

        jLabel3.setText("Time Range:");

        jLabel4.setText("Reader Parameters:");
        jLabel4.setToolTipText("Special parameters for the reader that implements the data source.  ");

        readerParamsTextArea.setColumns(20);
        readerParamsTextArea.setRows(5);
        jScrollPane2.setViewportView(readerParamsTextArea);

        jLabel5.setText("TCA Interval (sec):");
        jLabel5.setToolTipText("<html>\nInterval (in seconds) to use for TCA (ephemeris) data.<br>\nLeave blank for most datasets.  For TCA data, specify a cadence based on the rate of change of the data.<br>\n</html>\n");

        tcaTextField.setText(" ");
        tcaTextField.setToolTipText("<html> Interval (in seconds) to use for TCA (ephemeris) data.<br> Leave blank for most datasets.<br> </html> ");

        jLabel6.setText("TCA Item:");
        jLabel6.setToolTipText("The optional item number for TCAs.");

        tcaItem.setToolTipText("The optional item number for TCAs.");

        viewDsdfButton.setText("View DSDF");
        viewDsdfButton.setToolTipText("View the DSDF configuration file on the server");
        viewDsdfButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                viewDsdfButtonActionPerformed(evt);
            }
        });

        validRangeLabel.setFont(new java.awt.Font("DejaVu LGC Sans", 0, 10)); // NOI18N
        validRangeLabel.setText("<html><i>no valid range for dataset provided</i></html>");

        discoveryCb.setText("require example time");
        discoveryCb.setToolTipText("Show only datasets that have identified example times.  These should be a higher quality, and can be tested by a machine.");
        discoveryCb.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                discoveryCbActionPerformed(evt);
            }
        });

        examplesComboBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "<html><i>Example Time Ranges</i>", " " }));
        examplesComboBox.setToolTipText("Example times specified in the data set descriptor file");
        examplesComboBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                examplesComboBoxActionPerformed(evt);
            }
        });

        jLabel7.setText("Description:");
        jLabel7.setToolTipText("Description provided by the server (in its dsdf file)");

        descriptionLabel.setText(" ");

        timeRangeTool.setIcon(new javax.swing.ImageIcon(getClass().getResource("/org/das2/datasource/calendar.png"))); // NOI18N
        timeRangeTool.setToolTipText("Time Range Tool");
        timeRangeTool.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                timeRangeToolActionPerformed(evt);
            }
        });

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(layout.createSequentialGroup()
                        .add(24, 24, 24)
                        .add(jScrollPane2))
                    .add(layout.createSequentialGroup()
                        .addContainerGap()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                            .add(das2ServerComboBox, 0, 630, Short.MAX_VALUE)
                            .add(jLabel1)
                            .add(layout.createSequentialGroup()
                                .add(jLabel2)
                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                .add(discoveryCb))
                            .add(jScrollPane1)))
                    .add(layout.createSequentialGroup()
                        .addContainerGap()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, layout.createSequentialGroup()
                                .add(jLabel7)
                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                .add(descriptionLabel, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .add(org.jdesktop.layout.GroupLayout.LEADING, layout.createSequentialGroup()
                                .add(jLabel4)
                                .add(0, 0, Short.MAX_VALUE))
                            .add(layout.createSequentialGroup()
                                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                                    .add(layout.createSequentialGroup()
                                        .add(21, 21, 21)
                                        .add(validRangeLabel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 267, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                        .add(examplesComboBox, 0, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                                    .add(org.jdesktop.layout.GroupLayout.LEADING, layout.createSequentialGroup()
                                        .add(jLabel3)
                                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                        .add(timeRangeTextField)
                                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                                        .add(timeRangeTool)))
                                .add(18, 18, 18)
                                .add(viewDsdfButton))))
                    .add(layout.createSequentialGroup()
                        .addContainerGap()
                        .add(jLabel5)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(tcaTextField, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 70, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(jLabel6)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(tcaItem, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 42, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(jLabel1)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(das2ServerComboBox, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .add(5, 5, 5)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel2)
                    .add(discoveryCb))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jScrollPane1, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 240, Short.MAX_VALUE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel7)
                    .add(descriptionLabel))
                .add(7, 7, 7)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(viewDsdfButton)
                    .add(timeRangeTool)
                    .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                        .add(jLabel3)
                        .add(timeRangeTextField, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(examplesComboBox, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(validRangeLabel, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jLabel4)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jScrollPane2, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 53, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel5)
                    .add(tcaTextField, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jLabel6)
                    .add(tcaItem, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    DatumRange validTimeRange= null; // some timerange believed to be valid.
    
    /**
     * this is called off the event thread for the web transaction, then hop back on it to populate the GUI.
     * @param url
     */
    private void updateDataSetSelected( URL url ) {
        InputStream in= null;
        try {
            in = url.openStream();
            StringBuilder sb = new StringBuilder();
            int by = in.read();
            while (by != -1) {
                sb.append((char) by);
                by = in.read();
            }
            in.close();
            String s = sb.toString();
            final int packetTagLength=10;

            int contentLength = Integer.parseInt(s.substring(4, packetTagLength )); // "[00]000192<stream > <properties validRange="1999-228 to 2010-359" server="http://planet.physics.uiowa.edu/das-test/das2Server" das2Stream="0" qstream="1" exampleRange="2010-001 to 2010-002" /> </stream>"
            String sxml = s.substring( packetTagLength, packetTagLength + contentLength);
            Reader xin = new BufferedReader(new StringReader(sxml));
            DocumentBuilder builder;
            builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
            InputSource source = new InputSource(xin);
            final Document document = builder.parse(source);

            Runnable run = new Runnable() {
                @Override
                public void run() {
                    try {
                    validTimeRange= null;
                    boolean isTca= false;

                    XPathFactory factory = XPathFactory.newInstance();
                    XPath xpath = (XPath) factory.newXPath();

                    String curr= Das2ServerDataSourceEditorPanel.this.timeRangeTextField.getText();

                    Node description= (Node) xpath.evaluate( "/stream/properties/@description", document, XPathConstants.NODE );
                    descriptionLabel.setText( description==null ? "" : description.getNodeValue() );

                    NodeList exs=  (NodeList) xpath.evaluate( "/stream/properties/@*", document, XPathConstants.NODESET );
                    List<String> examples= new ArrayList<String>();
                    String example= null;
                    for ( int i=0; i<exs.getLength(); i++ ) {
                        Node ex= exs.item(i);
                        if ( ex.getNodeName().startsWith("exampleRange") ) {
                            examples.add(ex.getNodeValue());
                        }
                        if (ex.getNodeName().equals("exampleRange") ) {
                            example= ex.getNodeValue();
                        }
                        if ( ex.getNodeName().equals("items") ) {
                            isTca= true;
                        }
                        if ( ex.getNodeName().equals("requiresInterval") ) {
                            isTca= !ex.getNodeValue().equals("0");
                        }
                    }
                    if ( example!=null && curr.equals(DEFAULT_TIMERANGE) ) { // DANGER: what if they are the same?
                        Das2ServerDataSourceEditorPanel.this.timeRangeTextField.setText( example );
                    }
                    if ( example!=null ) {
                        try {
                            validTimeRange= DatumRangeUtil.parseTimeRange(example);
                        } catch (ParseException ex) {
                            logger.info("default timerange doesn't parse!");
                        }                        
                    }
                    if ( examples.size()>0 ) {
                        for ( int i=0; i<examples.size(); i++ ) {
                            String s= examples.get(i);
                            int j= s.indexOf( EXAMPLE_TIMERANGE_LABEL_DELIM );
                            if ( j>-1 ) {
                                s= "<html>" + s.substring(0,j) + " <i><nbsp>"+s.substring(j+1).trim() + "</i>";
                            }
                            examples.set(i,s);
                        }
                        examples.add( 0, String.format( "<html><i>Example Time Ranges (%d)</i>", examples.size() ) );
                        DefaultComboBoxModel model= new DefaultComboBoxModel( examples.toArray( new String[examples.size()] ) );
                        Das2ServerDataSourceEditorPanel.this.examplesComboBox.setModel( model );
                        Das2ServerDataSourceEditorPanel.this.examplesComboBox.setEnabled(true);
                    } else {
                        DefaultComboBoxModel model= new DefaultComboBoxModel( new String[] { "No example time ranges found..." } );
                        Das2ServerDataSourceEditorPanel.this.examplesComboBox.setModel( model );
                        Das2ServerDataSourceEditorPanel.this.examplesComboBox.setEnabled(false);
                    }

                    if ( example==null ) { // legacy
                        Node exampleRange= (Node) xpath.evaluate( "/stream/properties/@x_range", document, XPathConstants.NODE );
                        if ( exampleRange!=null && curr.equals(DEFAULT_TIMERANGE) ) {
                            Das2ServerDataSourceEditorPanel.this.timeRangeTextField.setText( exampleRange.getNodeValue() );
                        }
                        if ( exampleRange!=null ) {
                            try {
                               validTimeRange= DatumRangeUtil.parseTimeRange(exampleRange.getNodeValue());
                            } catch (ParseException ex) {
                               logger.info("example timerange doesn't parse!");
                            }
                        }
                    }
                    
                    Node validRange= (Node)  xpath.evaluate( "/stream/properties/@validRange", document, XPathConstants.NODE );
                    if ( validRange!=null ) {
                        Das2ServerDataSourceEditorPanel.this.validRangeLabel.setText( "valid range: " + validRange.getNodeValue() );
                    } else {
                        Das2ServerDataSourceEditorPanel.this.validRangeLabel.setText("<html><i>no valid range for dataset provided</i></html>");
                    }
                    if ( isTca ) {
                        tcaTextField.setText("60");
                    } else {
                        tcaTextField.setText("");
                    }
                    } catch ( XPathExpressionException ex ) {
                        logger.log(Level.SEVERE, ex.getMessage(), ex);
                    }
                }
            };
            SwingUtilities.invokeLater(run);

        } catch (SAXException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (ParserConfigurationException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (MalformedURLException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } finally {
            try {
                if ( in!=null ) in.close();
            } catch (IOException ex) {
                logger.log(Level.SEVERE, ex.getMessage(), ex);
            }
        }
    }

    private void jTree1ValueChanged(javax.swing.event.TreeSelectionEvent evt) {//GEN-FIRST:event_jTree1ValueChanged
        TreePath p= evt.getPath();
        TreeModel m= ((JTree)evt.getSource()).getModel();
        if ( ! m.isLeaf( p.getLastPathComponent() ) ) {
            descriptionLabel.setText( "" );
            this.validRangeLabel.setText("<html><i>no dataset selected</i></html>");
            this.viewDsdfButton.setEnabled(false);
        } else {
            this.viewDsdfButton.setEnabled(true);
            this.validRangeLabel.setText("<html><i>retrieving dataset info...</i></html>");
            Object[] oo= p.getPath();
            StringBuilder ds= new StringBuilder( String.valueOf( oo[1] ) );
            for ( int i=2; i<oo.length; i++ ) {
                ds.append( "/" ).append( oo[i] );
            }
            String surl = oo[0] + "?server=dsdf&dataset=" + ds.toString();
            try {
                final URL url = new URL(surl);
                RequestProcessor.invokeLater( new Runnable() {
                    @Override
                    public void run() {
                        updateDataSetSelected( url );
                    }
                });
            } catch ( MalformedURLException ex ) {
                logger.log(Level.SEVERE, ex.getMessage(), ex);
                JOptionPane.showConfirmDialog( this, "Internal Error: "+ex.toString() ); // give a message
            }
        }
    }//GEN-LAST:event_jTree1ValueChanged


    private void updateDas2ServersImmediately() {
        d2ss= listDas2Servers();
        Runnable run= new Runnable() {
            @Override
            public void run() {
                das2ServerComboBox.setModel( new DefaultComboBoxModel(d2ss.toArray()) );
            
                if ( serverURL.length()==0 ) {
                    serverURL= d2ss.get(0);
                    RequestProcessor.invokeLater( getDataSetsRunnable() );
                }
                das2ServerComboBox.setSelectedItem(serverURL);
                das2ServerComboBox.setRenderer(myListCellRenderer);
            }
        };
        SwingUtilities.invokeLater(run);
    }

    
    private static final Map<String,ImageIcon> icons= Collections.synchronizedMap( new HashMap() );
    
    private static Icon iconFor( Object o, boolean wait ) {
        //return new javax.swing.ImageIcon(Das2ServerDataSourceEditorPanel.class.getResource("/org/virbo/datasource/fileMag.png"));
        //icons.clear(); // for debugging
        ImageIcon result= icons.get(o.toString());
        if (result==null && wait ) {
            try {
                long t1= System.currentTimeMillis();
                result= new ImageIcon( new URL( "" + o +"?server=logo" ) );
                Image im= result.getImage();
                int h= im.getWidth(null);
                int w= im.getHeight(null);
                int s= 20;
                int h1= Math.min(24,s*w/h);
                BufferedImage bi=  new BufferedImage( s, h1, BufferedImage.TYPE_INT_ARGB);
                Graphics g= bi.createGraphics();
                g.drawImage( im, 0, 0, s, h1, null, null );
                result= new ImageIcon(bi);
                logger.log(Level.FINE, "time to load icon for {0}: {1} ms", new Object[]{ o, System.currentTimeMillis()-t1});
                icons.put( o.toString(), result );
            } catch (MalformedURLException ex) {
                Logger.getLogger(Das2ServerDataSourceEditorPanel.class.getName()).log(Level.SEVERE, null, ex);
            }
        } 
        return result;
    }
    
    private static class IconCellRenderer implements ListCellRenderer {
        DefaultListCellRenderer r= new DefaultListCellRenderer();
        @Override
        public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
            Component c= r.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);
            Icon icon= iconFor( value, false );
            ((DefaultListCellRenderer)c).setIcon(icon);
            return c;
        }
    }
    
    private final ListCellRenderer myListCellRenderer= new IconCellRenderer();
    
    private List<String> listPeers( String suri ) {

        String uri= suri+"?server=peers";

        List<String> result= new ArrayList();

        InputStream in=null;
        
        try {
            in = new URL(uri).openStream();

            DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
            InputSource source = new InputSource(in);
            Document initialDocument = builder.parse(source);

            XPathFactory factory = XPathFactory.newInstance();
            XPath xpath = factory.newXPath();

            NodeList urls = (NodeList) xpath.evaluate("//das2server/peers/server/url/text()", initialDocument, XPathConstants.NODESET );

            for ( int i=0; i<urls.getLength(); i++ ) {
                result.add(urls.item(i).getNodeValue());
            }
            
        } catch (MalformedURLException ex) {
            logger.log(Level.SEVERE, "listPeers("+uri+")\n"+ex.getMessage(), ex);
        } catch (IOException ex) {
            logger.log(Level.SEVERE, "listPeers("+uri+")\nresults in:\n"+ex.getMessage(), ex);
        } catch (ParserConfigurationException ex) {
            logger.log(Level.SEVERE, "listPeers("+uri+")\nresults in:\n"+ex.getMessage(), ex);
        } catch (SAXException ex) {
            logger.log(Level.SEVERE, "listPeers("+uri+")\nresults in:\n"+ex.getMessage(), ex);
        } catch (XPathExpressionException ex) {
            logger.log(Level.SEVERE, "listPeers("+uri+")\nresults in:\n"+ex.getMessage(), ex);
        } finally {
            try {
                if ( in!=null ) in.close();
            } catch (IOException ex) {
                Logger.getLogger(Das2ServerDataSourceEditorPanel.class.getName()).log(Level.SEVERE, null, ex);
            }
            return result;
        }
    }

    /**
     * add the default known servers, plus the ones we know about.
     */
    private List<String> listDas2Servers() {
        List<String> d2ss1= new ArrayList( );
        d2ss1.add( "http://www-pw.physics.uiowa.edu/das/das2Server" );

        if ( serverURL.length()==0 ) {
            d2ss1.addAll( listPeers("http://www-pw.physics.uiowa.edu/das/das2Server") );
        } else {
            d2ss1.addAll( listPeers(serverURL) );
        }

        File home = new File(AutoplotSettings.settings().resolveProperty(AutoplotSettings.PROP_AUTOPLOTDATA));
        File book = new File(home, "bookmarks");
        File hist = new File(book, "history.txt");
        long t0= System.currentTimeMillis();
        logger.log( Level.FINE, "reading recent datasources from {0}", hist.toString());

        if ( hist.exists() ) {
            BufferedReader r=null;
            try {
                String seek="vap+das2server:";
                int ttaglen= 25;
                r = new BufferedReader(new FileReader(hist));
                String s = r.readLine();
                LinkedHashSet dss = new LinkedHashSet();

                while (s != null) {
                    if ( s.length()>ttaglen && s.substring(ttaglen).startsWith(seek)) {
                        int i= s.indexOf("?");
                        if ( i==-1 ) i= s.length();
                        String key= s.substring(ttaglen+seek.length(),i);
                        if ( dss.contains(key) ) dss.remove( key ); // move to the end
                        dss.add( key );
                    }
                    s = r.readLine();
                }

                d2ss1.removeAll(dss);  // remove whatever we have already
                List<String> d2ssDiscoveryList= new ArrayList(dss);
                Collections.reverse( d2ssDiscoveryList );
                d2ssDiscoveryList.addAll(d2ss1);
                d2ss1= d2ssDiscoveryList; // put the most recently used ones at the front of the list
                
                logger.log( Level.FINE, "read extra das2servers in {0} millis\n", (System.currentTimeMillis()-t0) );
            } catch ( IOException ex ) {
                logger.log( Level.FINE, "IOException when reading in {0}", hist );
                JOptionPane.showConfirmDialog(examplesComboBox,"IOException when reading in "+hist );
            } finally {
                try {
                    if ( r!=null ) r.close();
                } catch (IOException ex) {
                    logger.log( Level.SEVERE, ex.getMessage(), ex );
                }
            }
        } else {
            logger.log( Level.FINE, "no history file found: {0}", hist );
        }
        
        final List<String> fd2ss1= d2ss1;
        Runnable run= new Runnable() {
            @Override
            public void run() {
                for ( String s: fd2ss1 ) {
                    Icon i= iconFor( s, true ); // force load of icon off the event thread.
                    i.getIconHeight();                      
                }
            };
        };
        new Thread(run,"loadDas2ServerIcons").start();
        
        return d2ss1;

    }

    private void showDsdf( URL url ) {
      InputStream in= null ;
        try {
            in = url.openStream();

            StringBuilder sb= new StringBuilder();

            int by= in.read();
            while ( by!=-1 ) {
                sb.append( (char)by );
                by= in.read();
            }

            String s= sb.toString();
            int contentLength= Integer.parseInt( s.substring(4,10) );
            String sxml= s.substring(10,10+contentLength);

            Reader xin = new BufferedReader(new StringReader(sxml));

            DocumentBuilder builder;
            builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
            InputSource source = new InputSource(xin);
            Document document = builder.parse(source);

            XPathFactory factory= XPathFactory.newInstance();

            XPath xpath= (XPath) factory.newXPath();
            NodeList o= (NodeList)xpath.evaluate( "/stream/properties/@*", document, XPathConstants.NODESET );

            StringBuilder result= new StringBuilder("");
            for ( int ii=0; ii<o.getLength(); ii++ ) {
                result.append(  o.item(ii).getNodeName() ).append( "  =  " ) .append(  o.item(ii).getNodeValue() ) .append( "\n" );
            }

            final String fresult= result.toString();

            Runnable run= new Runnable() {
                @Override
                public void run() {
                    JTextArea area= new JTextArea();
                    area.setText(fresult);
                    area.setEditable(false);
                    final JPopupMenu copyMenu= new JPopupMenu();
                    copyMenu.add( new DefaultEditorKit.CopyAction() ).setText("Copy");
                    area.addMouseListener( new MouseAdapter() {
                        @Override
                        public void mousePressed(MouseEvent e) {
                            if ( e.isPopupTrigger() ) copyMenu.show(e.getComponent(), e.getX(), e.getY() );
                        }
                        @Override
                        public void mouseReleased(MouseEvent e) {
                            if ( e.isPopupTrigger() ) copyMenu.show(e.getComponent(), e.getX(), e.getY() );
                        }
                    });
                    JScrollPane sp= new JScrollPane( area,JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED, JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED );
                    sp.setPreferredSize(new java.awt.Dimension( 480,480));
                    JOptionPane.showMessageDialog( Das2ServerDataSourceEditorPanel.this, sp );

                }
            };
            SwingUtilities.invokeLater(run);


        } catch (XPathExpressionException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (SAXException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (ParserConfigurationException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(examplesComboBox, "Unable to parse dsdf: "+ ex.getMessage() );
            logger.log(Level.SEVERE, ex.getMessage(), ex);
        } finally {
            try {
                if ( in!=null ) in.close();
            } catch (IOException ex) {
                logger.log(Level.SEVERE, ex.getMessage(), ex);
            }
        }

    }

    private void viewDsdfButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_viewDsdfButtonActionPerformed
        org.das2.util.LoggerManager.logGuiEvent(evt);
        TreePath p= jTree1.getSelectionPath();
        TreeModel m= jTree1.getModel();
        if ( p==null ) {
            JOptionPane.showConfirmDialog( this, "No dataset selected" );
            return;
        }
        if ( m.isLeaf( p.getLastPathComponent() ) ) {
            {
                try {
                    Object[] oo = p.getPath();
                    StringBuilder ds = new StringBuilder( String.valueOf(oo[1]) );
                    for (int i = 2; i < oo.length; i++) {
                        ds.append( "/" ).append( oo[i] );
                    }
                    String surl = oo[0] + "?server=dsdf&dataset=" + ds.toString();

                    final URL url = new URL(surl);

                    RequestProcessor.invokeLater( new Runnable() {
                        @Override
                        public void run() {
                            showDsdf(url);
                        }
                    } );
                    
                } catch ( MalformedURLException ex ) {
                    logger.log(Level.SEVERE, ex.getMessage(), ex);
                    JOptionPane.showConfirmDialog( this, "Internal Error: "+ex.toString() ); // give a message
                }
            }
        }
    }//GEN-LAST:event_viewDsdfButtonActionPerformed

    private void das2ServerComboBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_das2ServerComboBoxActionPerformed
        org.das2.util.LoggerManager.logGuiEvent(evt);
        Object o= das2ServerComboBox.getSelectedItem();
        if ( o!=null ) {
            try {
                URL url= new URL(String.valueOf(o));
                setServerURL( url.toString() );
            } catch (MalformedURLException ex) {
                if ( !String.valueOf(o).contains(":") ) {
                    JOptionPane.showMessageDialog(this,"<html>Invalid URL (no http):<br>"+o);
                } else {
                    JOptionPane.showMessageDialog(this,"<html>Invalid URL:<br>"+o);
                }
            }
        }
    }//GEN-LAST:event_das2ServerComboBoxActionPerformed

    private void discoveryCbActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_discoveryCbActionPerformed
        org.das2.util.LoggerManager.logGuiEvent(evt);
        jTree1.setModel( waitTreeModel() );
        RequestProcessor.invokeLater( getDataSetsRunnable() );
    }//GEN-LAST:event_discoveryCbActionPerformed

    private void examplesComboBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_examplesComboBoxActionPerformed
        org.das2.util.LoggerManager.logGuiEvent(evt);
        String item= (String) examplesComboBox.getSelectedItem();
        if ( !item.equals(EXAMPLE_TIME_RANGES) ) {
            int i= item.indexOf("<i>");
            if ( i>-1 && item.startsWith("<html>") ) {
                timeRangeTextField.setText(item.substring(6,i).trim());
            } else {
                timeRangeTextField.setText(item.trim());
            }
        }
    }//GEN-LAST:event_examplesComboBoxActionPerformed

    private void timeRangeToolActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_timeRangeToolActionPerformed
        org.das2.util.LoggerManager.logGuiEvent(evt);
        TimeRangeTool tt= new TimeRangeTool();
        JTextField tf= timeRangeTextField;
        tt.setSelectedRange(tf.getText());
        int r= JOptionPane.showConfirmDialog( this, tt, "Select Time Range", JOptionPane.OK_CANCEL_OPTION );
        if ( r==JOptionPane.OK_OPTION) {
            tf.setText(tt.getSelectedRange());
        }
    }//GEN-LAST:event_timeRangeToolActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    public javax.swing.JComboBox das2ServerComboBox;
    public javax.swing.JLabel descriptionLabel;
    public javax.swing.JCheckBox discoveryCb;
    public javax.swing.JComboBox examplesComboBox;
    public javax.swing.JLabel jLabel1;
    public javax.swing.JLabel jLabel2;
    public javax.swing.JLabel jLabel3;
    public javax.swing.JLabel jLabel4;
    public javax.swing.JLabel jLabel5;
    public javax.swing.JLabel jLabel6;
    public javax.swing.JLabel jLabel7;
    public javax.swing.JScrollPane jScrollPane1;
    public javax.swing.JScrollPane jScrollPane2;
    public javax.swing.JTree jTree1;
    public javax.swing.JTextArea readerParamsTextArea;
    public javax.swing.JTextField tcaItem;
    public javax.swing.JTextField tcaTextField;
    public javax.swing.JTextField timeRangeTextField;
    public javax.swing.JButton timeRangeTool;
    public javax.swing.JLabel validRangeLabel;
    public javax.swing.JButton viewDsdfButton;
    // End of variables declaration//GEN-END:variables


    protected String serverURL = "";
    public static final String PROP_SERVERURL = "serverURL";

    public String getServerURL() {
        return serverURL;
    }

    public void setServerURL(String serverURL) {
        String oldServerURL = this.serverURL;
        this.serverURL = serverURL;
        if ( !this.serverURL.equals(oldServerURL) ) {
            //timeRangeTextField.setText( DEFAULT_TIMERANGE );
            descriptionLabel.setText("");
            jTree1.setModel( waitTreeModel() );
            RequestProcessor.invokeLater( getDataSetsRunnable() );
        }
        firePropertyChange(PROP_SERVERURL, oldServerURL, serverURL);
    }

    protected String dataSetId = null;
    public static final String PROP_DATASETID = "dataSetId";

    public String getDataSetId() {
        return dataSetId;
    }

    public void setDataSetId(String dataSetId) {
        String oldDataSetId = this.dataSetId;
        this.dataSetId = dataSetId;
        firePropertyChange(PROP_DATASETID, oldDataSetId, dataSetId);
    }

    @Override
    public JPanel getPanel() {
        return this;
    }

    @Override
    public boolean reject(String uri) throws Exception {
        URISplit split = URISplit.parse(uri);
        if ( split.file==null || split.file.equals("file:///") ) { // use UIOWA's main one by default.
            split.file= "http://www-pw.physics.uiowa.edu/das/das2Server";
        }
        String s= split.file;
        if ( s.equals("http://www-pw.physics.uiowa.edu/das/das2Server") ) {
            return false;
        }
        URL url= new URL(s+"?server=logo");
        URLConnection connect= url.openConnection();
        try {
            InputStream in= connect.getInputStream();
            if ( connect.getContentType().startsWith("image") ) {
                in.close();
                return false;
            } else {
                in.close();
                return true;
            }
        } catch ( IOException ex ) {
            return false; // we'll tell them later
        }
    }


    @Override
    public boolean prepare( String uri, java.awt.Window parent, ProgressMonitor mon) {
        return true;
    }

    @Override
    public void setURI(String uri) {

        URISplit split= URISplit.parse(uri);

        String uriServerUrl= DataSetURI.fromUri( split.resourceUri );
        if ( uriServerUrl.length()>0 && !uriServerUrl.startsWith("file:/") ) {
            serverURL= uriServerUrl;
        } else {
            serverURL= "";
        }

        Map<String,String> params= URISplit.parseParams(split.params);
        dataSetId= params.remove("dataset");
        if ( dataSetId==null ) {
            dataSetId= params.remove("arg_0");
        }
        if ( dataSetId!=null && dataSetId.startsWith("/") ) {
            dataSetId= dataSetId.substring(1);
        }
        String startTime= params.remove("start_time");
        String endTime= params.remove("end_time");
        String str= params.remove("timerange");
        if ( str!=null ) {
            DatumRange tr;
            try {
                tr = DatumRangeUtil.parseTimeRange( str );
                startTime= tr.min().toString();
                endTime= tr.max().toString();
            } catch (ParseException ex) {
                logger.log(Level.SEVERE, ex.getMessage(), ex);
            }
        }
        if ( startTime!=null && endTime!=null ) {
            try {
                Datum t1= TimeUtil.create( startTime );
                Datum t2= TimeUtil.create( endTime );
                DatumRange dr = new DatumRange( t1, t2 );
                timeRangeTextField.setText(dr.toString());
            } catch ( ParseException ex ) {
                timeRangeTextField.setText( DEFAULT_TIMERANGE );
            }
        } else {
            timeRangeTextField.setText( DEFAULT_TIMERANGE );
        }
        String interval= params.remove("interval");
        if ( interval!=null ) {
            tcaTextField.setText(interval);
        }
        String item= params.remove("item");
        if ( item!=null ) {
            tcaItem.setText(item);
        }
        StringBuilder paramsStr= new StringBuilder();
        for ( Entry<String,String> e: params.entrySet() ) {
            if ( e.getKey().startsWith("arg_") ) {
                paramsStr.append(e.getValue()).append("\n");
            } else {
                paramsStr.append(e.getKey()).append("=").append(e.getValue()).append("\n");
            }
        }
        readerParamsTextArea.setText(paramsStr.toString());

        updateDas2ServersImmediately(); // this will set serverUrl to the last used server if nothing is specified.

        Runnable run = new Runnable() {
            public void run() {
                das2ServerComboBox.setSelectedItem(serverURL);
                jTree1.setModel( waitTreeModel() );
            }
        };
        SwingUtilities.invokeLater(run);
        
        if ( serverURL.length()>0 ) {
            RequestProcessor.invokeLater( getDataSetsRunnable() );
        }

    }

    TreeModel waitTreeModel() {
        DefaultMutableTreeNode treeNode1 = new DefaultMutableTreeNode("updating, please wait..." );
        return new javax.swing.tree.DefaultTreeModel(treeNode1);
    }
	 
    /**
     * Class to handle custom rendering of the dataset list.  The DefaultTreeCellRenderer
     * is just a JLable derived object.  So those are the functions being used to get the
     * display properly rendered
     */
    private class DataSetItemRenderer extends DefaultTreeCellRenderer {

        @Override
        public Component getTreeCellRendererComponent(JTree tree, Object value,
                boolean bSelected, boolean bExpanded, boolean bIsLeaf, int iRow, boolean bHasFocus) {
            super.getTreeCellRendererComponent(tree, value, bSelected, bExpanded, bIsLeaf, iRow,
                    bHasFocus);

            DefaultMutableTreeNode tn = (DefaultMutableTreeNode) value;
            Object obj = tn.getUserObject();

            if (obj instanceof DasServer.DataSrcListItem) {
                DasServer.DataSrcListItem li = (DasServer.DataSrcListItem) obj;

                if (li.description() == null) {
                    setText(String.format("<html>%s", li.name()));
                } else {
                    setText(String.format("<html>%s &nbsp;<i>%s</i>", li.name(), li.description()));
                }
            }

            return this;
        }
    }

    private void updateTree( TreeModel model ) {
        jTree1.setModel(model);
		jTree1.setCellRenderer(new DataSetItemRenderer());
        if ( dataSetId!=null ) selectDataSetId();
    }

    Runnable getDataSetsRunnable() {
        Runnable run= new Runnable() {
            @Override
            public void run() {

                String ss1= serverURL;

                try {
                    DasServer server= DasServer.create( new URL( ss1 ) );
                    final TreeModel model;
                    if ( discoveryCb.isSelected() ) {
                        model= server.getDataSetListWithDiscovery();
                    } else {
                        model= server.getDataSetList();
                    }
                    updateDas2ServersImmediately();
                    SwingUtilities.invokeLater( new Runnable() {
                        public void run() {
                            updateTree(model);
                        }
                    });
                    
                } catch (DasException ex) {

                    logger.log(Level.SEVERE, ex.getMessage(), ex);

                    javax.swing.tree.DefaultMutableTreeNode treeNode1 = new javax.swing.tree.DefaultMutableTreeNode("Error connecting to " + ss1 + ", \n" + ex );
                    jTree1.setModel(new javax.swing.tree.DefaultTreeModel(treeNode1));

                } catch (MalformedURLException ex) {
                    javax.swing.tree.DefaultMutableTreeNode treeNode1 = new javax.swing.tree.DefaultMutableTreeNode("Error connecting to " + ss1 + ", \n" + ex );
                    jTree1.setModel(new javax.swing.tree.DefaultTreeModel(treeNode1));
                    
                }

            }
        };
        return run;
    }

    private void selectDataSetId() {
        String[] ss= dataSetId.split("/");
        TreeNode[] oo= new TreeNode[ss.length+1];
        oo[0]= (TreeNode) jTree1.getModel().getRoot();
        for ( int i=1; i<oo.length; i++ ) {
            for ( int j=0; j<oo[i-1].getChildCount(); j++ ) {
                DefaultMutableTreeNode kid= (DefaultMutableTreeNode) oo[i-1].getChildAt(j);
                if ( ((DasServer.DataSrcListItem)kid.getUserObject()).name().equals( ss[i-1] ) ) {
                    oo[i]= kid;
                    break;
                }
            }
            if ( oo[i]==null ) {
                return;
            }
        }
        final TreePath tp= new TreePath( oo );
        Runnable run= new Runnable() {
            @Override
            public void run() {
            jTree1.setSelectionPath(tp);
            jTree1.scrollPathToVisible(tp);
            }
        };
        SwingUtilities.invokeLater(run);
        
    }

    @Override
    public String getURI() {

        TreePath tp=  jTree1.getSelectionPath();
        if ( tp==null ) {
            return "vap+das2server:"+serverURL + "?" ;
        }

        boolean folder= !jTree1.getModel().isLeaf(tp.getLastPathComponent());
        Object[] tp0= tp.getPath();

        DatumRange timeRange;
        try {
            timeRange = DatumRangeUtil.parseTimeRange(timeRangeTextField.getText());
        } catch (ParseException ex) {
            logger.log(Level.SEVERE, ex.getMessage(), ex);
            timeRange= this.validTimeRange;
            if ( timeRange==null ) {
                throw new IllegalArgumentException("No timerange for the URI."); // too bad we can't check reject and reenter the GUI...  Surely it does this...
            }
        }
        
        StringBuilder ldataSetId= new StringBuilder("");
        if (tp0.length > 1) {
            DefaultMutableTreeNode tn = (DefaultMutableTreeNode) tp0[1];
            DasServer.DataSrcListItem li = (DasServer.DataSrcListItem) tn.getUserObject();
            ldataSetId = new StringBuilder(li.name());
            for (int i = 2; i < tp0.length; i++) {
                tn = (DefaultMutableTreeNode) tp0[i];
                li = (DasServer.DataSrcListItem) tn.getUserObject();
                ldataSetId.append("/").append(li.name());
            }
        }
        if ( folder ) ldataSetId.append("/");

        StringBuilder params= new StringBuilder();
        String readerParams= readerParamsTextArea.getText();
        String[] ss= readerParams.split("\n");
        for ( int i=0; i<ss.length; i++ ) {
            String ss1= ss[i].trim();
            if ( ss1.length()==0 ) continue;
            String[] ss2= ss1.split("\\s+");
            for ( int j=0; j<ss2.length; j++ ) {
                String[] ss3= ss2[j].split("\\s*=\\s*",-2);
                if ( ss3.length==1 ) {
                    params.append( URLEncoder.encode(ss3[0].trim()) );
                } else {
                    params.append( URLEncoder.encode(ss3[0].trim())).append("=").append( URLEncoder.encode(ss3[1].trim() ));
                }
                if ( i<ss.length-1 || j<ss2.length-1 ) {
                    params.append("%20");  //TODO: I don't think this is correct...  See https://sourceforge.net/p/autoplot/bugs/1103/
                }
            }
        }
        
        StringBuilder result= new StringBuilder("vap+das2server:");
        result.append(serverURL).append("?").append("dataset=").append(ldataSetId.toString());
        if ( timeRange!=null ) {
            result.append("&start_time=").append(timeRange.min()).append("&end_time=").append(timeRange.max());
        }
        String tcaInterval= tcaTextField.getText().trim();
        if ( !tcaInterval.equals("") ) {
            result.append("&interval=").append(tcaInterval);
        }
        if ( !tcaItem.getText().trim().equals("") ) {
            result.append("&item=").append(tcaItem.getText().trim());
        }
        
        if ( params.length()>0 ) result.append("&").append(params.toString());
        
        
        return result.toString();
    }

    @Override
    public void markProblems(List<String> problems) {

    }


    //private boolean expert;
    
    /**
     * call this before prepare.
     * @param expert
     */
    public void setExpertMode( boolean expert ) {
        //this.expert= expert;
        this.discoveryCb.setSelected(!expert);
    }
}
