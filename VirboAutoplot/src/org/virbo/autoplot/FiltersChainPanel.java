/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package org.virbo.autoplot;

import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.LinkedList;
import java.util.List;
import javax.swing.BoxLayout;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JSeparator;
import javax.swing.SwingUtilities;
import org.das2.util.monitor.NullProgressMonitor;
import org.virbo.dataset.DataSetOps;
import org.virbo.dataset.QDataSet;
import org.virbo.filters.CollapseFilterEditorPanel;
import org.virbo.filters.FilterEditorPanel;
import org.virbo.filters.SliceFilterEditorPanel;
import org.virbo.filters.SmoothFilterEditorPanel;

/**
 * Aggregate a number of sub panels to one long filter chain.  For example,
 * |slice1(0)|smooth(5) would add two of the FilterEditorPanel to control each
 * filter.  Additionally, this adds and removes filters from the chain.
 * 
 * @author jbf
 */
public class FiltersChainPanel extends javax.swing.JPanel implements FilterEditorPanel {
    private QDataSet inputDs;

    /**
     * Creates new form FiltersChainPanel
     */
    public FiltersChainPanel() {
        initComponents();
        setLayout( new BoxLayout( this, BoxLayout.Y_AXIS ));
    }

    List<FilterEditorPanel> editors= new LinkedList();

    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        setLayout(new javax.swing.BoxLayout(this, javax.swing.BoxLayout.LINE_AXIS));
    }// </editor-fold>//GEN-END:initComponents
    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables

    /**
     * this should return a delegate editor for the given filter.  
     * @param f the filter, which may or may not start with a pipe.
     * @return the filter.
     */
    private FilterEditorPanel getEditorFor(String f) {
        while ( f.startsWith("|") ) f= f.substring(1);
        if ( f.matches("slice\\d\\(.*\\)") ) {
            return new SliceFilterEditorPanel();
        } else if ( f.matches("collapse\\d\\(\\)") ) {
            return new CollapseFilterEditorPanel();
        } else if ( f.matches("smooth\\(\\d+\\)") ) { // TODO: FilterEditorPanel might choose to accept a filter.
            return new SmoothFilterEditorPanel();
        } else {
            throw new IllegalArgumentException("filter editor not found.");
        }
    }
    
    @Override
    public String getFilter() {
        StringBuilder b= new StringBuilder();
        for ( FilterEditorPanel p: editors ) {
            b.append(p.getFilter());
        }
        return b.toString();
    }

    @Override
    public void setFilter(String filter) {
        editors.clear();
        this.removeAll();
        String[] ss= filter.split("\\|");
        
        for (String s : ss) {
            s= s.trim();
            if ( s.length()>0 ) {
                FilterEditorPanel p = getEditorFor(s);
                p.setFilter("|"+s);
                editors.add(p);
                this.add(p.getPanel());
                this.add(new JSeparator());
            }
        }
        this.revalidate();
        
    }

    /**
     * 
     */
    private void updateSoon() {
        final String filter= getFilter();        
        Runnable run= new Runnable() {
            @Override
            public void run() {
                System.err.println("1: "+filter);
                System.err.println("2: "+getFilter());
                setFilter( getFilter() );
                setInput( inputDs );
            }
        };
        SwingUtilities.invokeLater(run);
    }
    
    /**
     * the filter must be set before this is called.  This will set droplist labels, etc.
     * @param ds 
     */
    @Override
    public void setInput( QDataSet ds) {
        this.inputDs= ds;
        
        this.removeAll();
        String filter= getFilter();
        System.err.println("filter: "+filter);
        
        String[] ss= filter.split("\\|");
        for (String s : ss) {
            s= s.trim();
            if ( s.length()>0 ) {
                FilterEditorPanel p = getEditorFor(s);
                p.setFilter("|"+s);
                
                if ( ds!=null ) {
                    p.setInput(ds);
                    try {
                        ds= DataSetOps.sprocess( "|"+s, ds, new NullProgressMonitor() );
                    } catch ( Exception ex ) {
                        ds= null;
                    }
                    PropertyChangeListener[] pcls= p.getPanel().getPropertyChangeListeners();
                    for ( PropertyChangeListener pcl: pcls ) {
                        p.getPanel().removePropertyChangeListener( pcl );
                    }
                    p.getPanel().addPropertyChangeListener("filter",new PropertyChangeListener() {
                        @Override
                        public void propertyChange(PropertyChangeEvent evt) {
                            updateSoon();
                        }
                    });
                }
                this.add(p.getPanel());
                this.add(new JSeparator());
            }
        }
        this.revalidate();        
    }

    @Override
    public JPanel getPanel() {
        return this;
    }
    
    public static void main( String[] args ) throws Exception {
        FiltersChainPanel ff= new FiltersChainPanel();

        QDataSet ds= org.virbo.jythonsupport.Util.getDataSet( "vap+cdfj:http://www.rbsp-ect.lanl.gov/data_pub/rbspa/mageis/level3/rbspa_rel02_ect-mageis-L3_20120909_v4.3.0.cdf?FEDU" );
        ff.setFilter("|slice0(2)|collapse1()|smooth(51)"); //butterworth(2,500,550,True)");
        ff.setInput(ds);
        JOptionPane.showMessageDialog( null, ff );
        System.err.println(ff.getFilter());
    }
}
