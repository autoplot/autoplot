
package org.virbo.jythonsupport.ui;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.UnknownHostException;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JDialog;
import javax.swing.JOptionPane;
import org.das2.components.DasProgressPanel;
import org.das2.util.LoggerManager;
import org.das2.util.filesystem.FileSystem;
import org.das2.util.monitor.ProgressMonitor;
import org.python.util.InteractiveInterpreter;
import org.virbo.datasource.DataSetURI;
import org.virbo.datasource.URISplit;
import org.virbo.jythonsupport.JythonUtil;

/**
 *
 * @author jbf
 */
public class BatchMaster extends javax.swing.JPanel {

    private final Logger logger= LoggerManager.getLogger("jython.batchmaster");
    
    /**
     * Creates new form MiracleMashMachine
     */
    public BatchMaster() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane2 = new javax.swing.JScrollPane();
        jList2 = new javax.swing.JList<>();
        param1Name = new javax.swing.JTextField();
        param2Name = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        jScrollPane3 = new javax.swing.JScrollPane();
        param1Values = new javax.swing.JTextArea();
        jScrollPane1 = new javax.swing.JScrollPane();
        param2Values = new javax.swing.JTextArea();
        dataSetSelector1 = new org.virbo.datasource.DataSetSelector();
        jButton2 = new javax.swing.JButton();
        jButton3 = new javax.swing.JButton();
        messageLabel = new javax.swing.JLabel();

        jList2.setModel(new javax.swing.AbstractListModel<String>() {
            String[] strings = { "Item 1", "Item 2", "Item 3", "Item 4", "Item 5" };
            public int getSize() { return strings.length; }
            public String getElementAt(int i) { return strings[i]; }
        });
        jScrollPane2.setViewportView(jList2);

        jButton1.setText("Go!");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        param1Values.setColumns(20);
        param1Values.setRows(5);
        jScrollPane3.setViewportView(param1Values);

        param2Values.setColumns(20);
        param2Values.setRows(5);
        jScrollPane1.setViewportView(param2Values);

        jButton2.setText("Test1");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jButton3.setText("Test2");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });

        messageLabel.setText("Load up those parameters and hit Go!");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jScrollPane3)
                    .addComponent(param1Name))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(param2Name)
                    .addComponent(jScrollPane1)))
            .addComponent(dataSetSelector1, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 474, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(messageLabel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jButton2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 62, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(dataSetSelector1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(8, 8, 8)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(param1Name, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(param2Name, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jScrollPane3, javax.swing.GroupLayout.DEFAULT_SIZE, 278, Short.MAX_VALUE)
                    .addComponent(jScrollPane1))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 9, Short.MAX_VALUE)
                .addComponent(messageLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jButton1)
                    .addComponent(jButton2)
                    .addComponent(jButton3))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        Runnable run= new Runnable() {
            public void run() {
                try {
                    doIt();
                } catch (IOException ex) {
                    messageLabel.setText(ex.getMessage());
                }
            }
        };
        new Thread(run).start();
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        param1Name.setText("ie");
        dataSetSelector1.setValue("/home/jbf/ct/autoplot/script/demos/paramTypes.jy");
        param1Values.setText("1\n2\n3\n");
    }//GEN-LAST:event_jButton2ActionPerformed

    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        try {
            dataSetSelector1.setValue("file:/home/jbf/ct/autoplot/userlog/20161116/reduceUserLogs.jy");
            param1Name.setText("resourceURI");
            StringBuilder sb= new StringBuilder();
            FileSystem fs= FileSystem.create("file:/home/jbf/ct/autoplot/userlog/20161116/");
            String[] ss= fs.listDirectoryDeep( "/", "access.autoplot.log.*.gz" ); 
            for ( String s: ss ) {
                sb.append( s+"\n" );
            }
            param1Values.setText(sb.toString());            
        } catch (UnknownHostException ex) {
            Logger.getLogger(BatchMaster.class.getName()).log(Level.SEVERE, null, ex);
        } catch (FileNotFoundException ex) {
            Logger.getLogger(BatchMaster.class.getName()).log(Level.SEVERE, null, ex);
        } catch (IOException ex) {
            Logger.getLogger(BatchMaster.class.getName()).log(Level.SEVERE, null, ex);
        }
    }//GEN-LAST:event_jButton3ActionPerformed

    public void doIt() throws IOException {
        ProgressMonitor monitor= DasProgressPanel.createFramed("batchMaster");
        try {
            String script= dataSetSelector1.getValue();
            if ( !script.endsWith(".jy") ) {
                JOptionPane.showMessageDialog( this, "script must end in .jy: "+script );
                return;
            }
            String[] ff= param1Values.getText().split("\n");
            monitor.setTaskSize(ff.length);
            monitor.started();
            File scriptFile= DataSetURI.getFile( script, monitor.getSubtaskMonitor("download script") );

            URISplit s= URISplit.parse(script);
            String pwd= s.path;
                    
            for ( String f : ff ) {
                try {
                    monitor.setProgressMessage(f);
                    if ( monitor.isCancelled() ) break;
                    monitor.setTaskProgress(monitor.getTaskProgress()+1);
                    InteractiveInterpreter interp = JythonUtil.createInterpreter( false );
                    interp.set( "monitor", monitor.getSubtaskMonitor(f) );
                    interp.exec("import autoplot");
                    String paramName= param1Name.getText();
                    
                    if ( paramName.equals("resourceURI" ) ) {
                        URI uri;
                        try {
                            URISplit split= URISplit.parse(f);
                            //uri= new URI(f);
                            uri= new URI( pwd + "/" + f );
                        } catch (Exception ex ) {
                            try {
                                uri= new URI( pwd + "/" + f );
                            } catch ( URISyntaxException ex2 ) {
                                throw new IOException(ex.toString());
                            }
                        }       
                        interp.set("apuri", uri );
                        interp.exec("autoplot.params[\'"+paramName+"\']=apuri");
                    } else {
                        interp.exec("autoplot.params[\'"+paramName+"\']="+f);
                    }
                    interp.execfile( new FileInputStream(scriptFile), scriptFile.getName() );

                } catch (IOException ex) {
                    Logger.getLogger(BatchMaster.class.getName()).log(Level.SEVERE, null, ex);
                }
            }
        } finally {
            monitor.finished();
        }
    }
    
    public static void main( String[] args ) {
        JDialog dia= new JDialog();
        dia.setResizable(true);
        BatchMaster mmm= new BatchMaster();
        dia.setContentPane( mmm );
        mmm.param1Name.setText("ie");
        mmm.dataSetSelector1.setValue("/home/jbf/ct/autoplot/script/demos/paramTypes.jy");
        mmm.param1Values.setText("1\n2\n3\n");
        dia.pack();
        dia.setVisible(true);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private org.virbo.datasource.DataSetSelector dataSetSelector1;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JList<String> jList2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JLabel messageLabel;
    private javax.swing.JTextField param1Name;
    private javax.swing.JTextArea param1Values;
    private javax.swing.JTextField param2Name;
    private javax.swing.JTextArea param2Values;
    // End of variables declaration//GEN-END:variables
}
